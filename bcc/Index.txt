@using BIPv2.Data.Domain.Enums
@model BIPv2.Application.Web.ViewModels.BaseViewModel<BIPv2.Application.Web.ViewModels.MessageViewModel>
@{
    ViewBag.Title = "Mesajlar";
}
<script src="/assets/common/js/plugins/ckEditor/ckeditor.js"></script>
<style>

    .item.new_window {
        display: none !important;
    }
</style>
@Html.Partial("_GridAndFilterCommon")
<script type="text/javascript">

    if (!Array.prototype.findIndex) {
        Object.defineProperty(Array.prototype, 'findIndex', {
            value: function (predicate) {
                // 1. Let O be ? ToObject(this value).
                if (this == null) {
                    throw new TypeError('"this" is null or not defined');
                }

                var o = Object(this);

                // 2. Let len be ? ToLength(? Get(O, "length")).
                var len = o.length >>> 0;

                // 3. If IsCallable(predicate) is false, throw a TypeError exception.
                if (typeof predicate !== 'function') {
                    throw new TypeError('predicate must be a function');
                }

                // 4. If thisArg was supplied, let T be thisArg; else let T be undefined.
                var thisArg = arguments[1];

                // 5. Let k be 0.
                var k = 0;

                // 6. Repeat, while k < len
                while (k < len) {
                    // a. Let Pk be ! ToString(k).
                    // b. Let kValue be ? Get(O, Pk).
                    // c. Let testResult be ToBoolean(? Call(predicate, T, « kValue, k, O »)).
                    // d. If testResult is true, return k.
                    var kValue = o[k];
                    if (predicate.call(thisArg, kValue, k, o)) {
                        return k;
                    }
                    // e. Increase k by 1.
                    k++;
                }

                // 7. Return -1.
                return -1;
            },
            configurable: true,
            writable: true
        });
    }

    var displayIndex = @Model.ViewModel.Display;
    var modelId = @Model.ViewModel.Id;
    var modelToId = @Model.ViewModel.ToId;
    var hasAccessUndoSentItem = '@(Model.CurrentUserData.Type == UserType.Admin || Model.CurrentUserData.Type == UserType.BSHSpecific || Model.CurrentUserData.Type == UserType.BSHGeneric)' == 'True';
    var gafMessages = [], filterModelMessages = [{ Seen: '' }, {}, {}, {}, {}];
    var mmessage = { ACTION: {}, common: {}, newMessage: {}, detail: {} };
    mmessage.ACTION.DeleteInboxItems = 0;
    mmessage.ACTION.DeleteSentboxItems = 1;
    mmessage.ACTION.DeleteTrashboxItems = 3;
    mmessage.ACTION.DeleteDraftItems = 4;
    mmessage.ACTION.UndoTrashboxItems = 5;
    mmessage.ACTION.Seen = 6;
    mmessage.ACTION.UnSeen = 7;
    mmessage.ACTION.NewMessage = 8;
    mmessage.ACTION.Forward = 9;
    mmessage.ACTION.Reply = 10;
    mmessage.ACTION.ReplyAll = 11;
    mmessage.ACTION.ClearNewMessage = 12;
    mmessage.ACTION.EditDraft = 13;
    mmessage.ACTION.UndoSentboxItems = 14;
    mmessage.INBOX = 0;
    mmessage.SENTBOX = 1;
    mmessage.DRAFT = 2;
    mmessage.TRASH = 3;
    mmessage.NEWMESSAGE = 4;
    mmessage.sendMessageUserIds = [];
    mmessage.sendMessageBCCUserIds = [];
    mmessage.toIdSeen = false;
    mmessage.IsBCC = false;
    mmessage.common.getMessageIds = function () {
        var ids = [], toIds = [];
        $('#bip-messages-incoming :checkbox:checked').each(function () {
            var $parent = $(this).parents('li.bip-message');
            var id = $parent.data('id');
            var toId = $parent.data('toid');
            if (toId > 0)
                toIds.push(toId);
            else
                ids.push(id);
        });
        return { ids: ids, toIds: toIds };
    };
    mmessage.common.displayBox = function (index, pageNo) {
        mmessage.index = index;
        $('.messagesArea').hide().eq(index).show();
        $('#messageDetailDiv').hide();
        mmessage.currentDisplayingMessageId = 0;

        if (index != 4)
            gafMessages[index].reloadData(pageNo);

        $('#messageListAndDetailContainer').toggle(index != 4);

        $('#messagesMenu li a').removeClass('active');
        $('#messagesMenu li a[data-index="' + index + '"]').addClass('active');
    };
    mmessage.common.actionMessage = function (action, idObj) {
        // idObj => { toIds: toIds, ids: ids }
        if (!idObj.toIds)
            idObj.toIds = [];

        if (!idObj.ids)
            idObj.ids = [];

        var url;
        var boxIndex = -1;
        if (action == mmessage.ACTION.DeleteInboxItems) {
            url = 'Message/DeleteInboxItems';
            boxIndex = 0;
        } else if (action == mmessage.ACTION.DeleteSentboxItems) {
            url = 'Message/DeleteSentboxItems';
            boxIndex = 1;
        } else if (action == mmessage.ACTION.DeleteTrashboxItems) {
            if (!confirm('Mesajlari tamamen silmek istediginizden emin misiniz?')) {
                return;
            }
            url = 'Message/DeleteTrashboxItems';
            boxIndex = 3;
        } else if (action == mmessage.ACTION.DeleteDraftItems) {
            if (!confirm('Taslaklari tamamen silmek istediginizden emin misiniz?')) {
                return;
            }
            url = 'Message/DeleteDraftItems';
            boxIndex = 2;
        } else if (action == mmessage.ACTION.UndoTrashboxItems) {
            url = 'Message/UndoTrashboxItems';
            boxIndex = 3;
        } else if (action == mmessage.ACTION.Seen) {
            url = 'Message/Seen';
        } else if (action == mmessage.ACTION.UnSeen) {
            url = 'Message/UnSeen';
        } else if (action == mmessage.ACTION.UndoSentboxItems) {
            if (!confirm('Mesaji tamamen silmek istediginizden emin misiniz?')) {
                return;
            }
            url = 'Message/UndoSentboxItems';
            boxIndex = 1;
        } else {
            return;
        }

        if (action == mmessage.ACTION.DeleteTrashboxItems ||
            action == mmessage.ACTION.DeleteDraftItems ||
            action == mmessage.ACTION.UndoSentboxItems) {
            mmessage.detail.hideFullscreen();
        }

        bip.ajax({
            url: url,
            data: idObj,
            success: function (data) {
                var actionSuccess = function (ids, isToId) {
                    for (var i = 0; i < ids.length; i++) {
                        if (!(ids[i] > 0)) {
                            continue;
                        }
                        var $tr = $('#bip-messages-incoming li.bip-message[data-' + (isToId ? 'to' : '') + 'id="' + ids[i] + '"]');
                        if (action == mmessage.ACTION.Seen) {
                            $tr.removeClass('bip-message-unread');
                            $tr.find('span.bip-icon').removeClass('icon-message').addClass('icon-read-message');
                        } else if (action == mmessage.ACTION.UnSeen) {
                            $tr.addClass('bip-message-unread');
                            $tr.find('span.bip-icon').removeClass('icon-read-message').addClass('icon-message');
                        } else { // delete actions
                            $tr.remove();
                            // remove message detail
                            $('.bip-messages-single[data-' + (isToId ? 'to' : '') + 'id="' + ids[i] + '"]').remove();
                        }
                    }

                    if (boxIndex >= 0 && ids.length > 0) {
                        if ($('#bip-messages-incoming li.bip-message').length == 0) {
                            var activePage = $('#bip-messages-incoming-paging .pagination .active a').html();
                            mmessage.common.displayBox(boxIndex, (!activePage || activePage == 1 ? 1 : activePage - 1));
                        } else {
                            gafMessages[boxIndex].refreshPaging(gafMessages[boxIndex].TotalItemCount - ids.length);
                        }
                    }
                };
                actionSuccess(idObj.toIds, 1);
                actionSuccess(idObj.ids, 0);

                $('.checkboxToggler').attr('checked', false);
            }
        });
    };
    mmessage.common.onLoad = function () {

        for (var i = 0; i < 5; i++) {
            var url;
            var emptyText;
            if (i == 0) {
                url = 'Message/Inbox';
                emptyText = 'Gelen kutusunda mesaj bulunmuyor.';
            } else if (i == 1) {
                url = 'Message/Sentbox';
                emptyText = 'Giden kutusunda mesaj bulunmuyor.';
            } else if (i == 2) {
                url = 'Message/Draftbox';
                emptyText = 'Kayitli taslak bulunmuyor.';
            } else if (i == 3) {
                url = 'Message/Trashbox';
                emptyText = 'Çöp kutusunda mesaj bulunmuyor.';
            } else if (i == 4) {
                //gafMessages.push(new GridAndFilter({
                //    url: 'Message/SearchUsersForSendingMessage',
                //    filterAreaContentId: 'filterAreaContentNewMessage',
                //    model: filterModelMessages[i],
                //    templateItemId: 'templateMessages' + i,
                //    containerMainId: 'containerMessages' + i,
                //    containerPagingId: 'pagingMessages' + i,
                //    reloadOnLoad: false,
                //    dontPushHistory: true
                //}));
            } else {
                return;
            }
            gafMessages.push(new GridAndFilter({
                url: url,
                filterAreaContentId: 'filterAreaContent' + i,
                model: filterModelMessages[i],
                templateItemId: 'templateMessages' + i,
                containerMainId: 'bip-messages-incoming',
                containerPagingId: 'bip-messages-incoming-paging',
                reloadOnLoad: false,
                dontPushHistory: true,
                emptyText: emptyText,
                onAfterDataLoaded : function(){
                    if($(".inscrollPane").length){
                        $('.inscrollPane').jScrollPane().data().jsp.destroy();
                        $('#bip-messages-incoming').parent().css("overflow-y", "auto");
                    }
                    var scrollable = $('#bip-messages-incoming').parent().addClass("inscrollPane");

                    if(scrollable.height() > 497){
                        scrollable.css("overflow-y", "scroll");
                        $('.inscrollPane').jScrollPane({
                            verticalDragMaxHeight: 30,
                            scrollByY: 10
                        });
                    }

                    var pane = $('.inscrollPane').find(".jspPane");
                    /*pane.css("border","1px solid #c3c3c4");*/
                    var count = $(".bip-messages-tabs").find('.bip-message').length;
                    if (count > 0) {
                        $(".bip-messages-tabs").css("border","1px solid #c3c3c4");
                    } else {
                        $(".bip-messages-tabs").css("border","none");
                    }
                    $('.bip-message-unread').find('.icon-read-message').removeClass('icon-read-message').addClass('icon-message');

                    $('#bip-messages-incoming li').not('input[name="cInboxItem"]').click(function(e) {
                        if($(e.target).is(':checkbox') || $(e.target).hasClass('bip-form-checkbox-label'))
                            return;

                        $(this).removeClass('bip-message-unread');
                        $(this).find('.icon-message').removeClass('icon-message').addClass('icon-read-message');
                        $('.bip-message').removeClass('activeMessage');
                        $(this).addClass('activeMessage');
                    });

                    $('.checkboxToggler').attr('checked', false);

                    if (!mmessage.toIdSeen) {
                        var $messageItem = $('.bip-message[data-toid="' + modelToId + '"]');
                        if ($messageItem.length > 0) {
                            $messageItem.addClass('activeMessage');
                            mmessage.toIdSeen = true;
                        }
                    }
                }
            }));
        }

        $('#messagesMenu li a').click(function (e) {
            $('#ToIdsDiv').val('');
            $('#BCCIdsDiv').val('');
            $('#ToIdsDivPreview').val('');
            $('#attachmentsContainer').html('');
            mmessage.sendMessageBCCUserIds = [];
            mmessage.sendMessageUserIds = [];
            e.preventDefault();
            var index = $(this).data('index');
            mmessage.common.displayBox(index);
            $('#messagesMenu li a').removeClass('active');
            $(this).addClass('active');
        });

        mmessage.common.displayBox(displayIndex);
        if (modelId > 0 || modelToId > 0) {
            mmessage.detail.display(modelId, modelToId);
        }

        $('.messagesArea').on('click', '#indexActionsDiv a', function (e) {
            e.preventDefault();
            var action = $(this).data('action');
            var idObj = mmessage.common.getMessageIds();
            if (idObj.ids.length == 0 && idObj.toIds.length == 0) return;
            mmessage.common.actionMessage(action, idObj);
        });

        $('.messagesArea').on('click', '.btnDeleteSentboxItems', function (e) {
            e.preventDefault();
            var idObj = mmessage.common.getMessageIds();
            mmessage.common.actionMessage(mmessage.ACTION.DeleteSentboxItems, idObj);
        });

        $('.messagesArea').on('click', '.btnDeleteTrashItems', function (e) {
            e.preventDefault();
            var idObj = mmessage.common.getMessageIds();
            mmessage.common.actionMessage(mmessage.ACTION.DeleteTrashboxItems, idObj);
        });

        $('.messagesArea').on('click', '.btnDeleteDraftItems', function (e) {
            e.preventDefault();
            var idObj = mmessage.common.getMessageIds();
            mmessage.common.actionMessage(mmessage.ACTION.DeleteDraftItems, idObj);
        });

        $('.messagesArea').on('click', '.btnUndoTrashItems', function (e) {
            e.preventDefault();
            var idObj = mmessage.common.getMessageIds();
            mmessage.common.actionMessage(mmessage.ACTION.UndoTrashboxItems, idObj);
        });

        CKEDITOR.replace('Body');
    };
    mmessage.common.calculateAttachmentsSize = function () {
        var $inputs = $('input[name*="Attachments"]');
        var maxFileSize = 104857600;
        var totalFileSize = 0;
        $.each($inputs, function(index, item) {
            totalFileSize += item.files[0].size;
        });
        if (totalFileSize > maxFileSize) {
            bip.errorAlert({ message: 'Maksimum dosya boyutu asildi.' });
            return false;
        }
        return true;
    }
    mmessage.newMessage.onLoad = function () {

        $('#formSendMessage').submit(function (e) {
            var $this = $(this);
            var body = CKEDITOR.instances.Body.getData();
            var subject = $this.find('input[name=Subject]').val();
            var action = $this.find('#Action').val();

            if (!subject || subject.length < 3) {
                bip.errorAlert({ message: 'Lütfen konu alanini giriniz.' });
                return false;
            }

            if (!body || body.length < 3) {
                bip.errorAlert({ message: 'Lütfen mesaj metnini giriniz.' });
                return false;
            }

            if (action != 'draft' && mmessage.sendMessageUserIds.length < 1 && mmessage.sendMessageBCCUserIds.length < 1) {
                bip.errorAlert({ message: 'Mesaj gönderilecek kisileri seçmediniz.' });
                return false;
            }

            if (!mmessage.common.calculateAttachmentsSize())
                return false;

            $this.find('#Body').val(body);
            //var idsInputHiddens = $this.find('#idsInputHiddens').html('');
            //var i = 0;
            //for (var a in mmessage.sendMessageUserIds) {
            //    idsInputHiddens.append('<input type="hidden" name="Ids[]" value="' + a + '"/>');
            //    i++;
            //}
            bip.loading(true);
            return true;
        }).find('button[type="submit"]').on('click', function () {
            $('#formSendMessage #Action').val(this.value);
        });

        $('#ToIdsDialogLink,#BCCIdsDialogLink').click(function (e) {
            SetIsBCC(this);
            e.preventDefault();
            window.clearNewUserSearchForm();

            var $ddlUserStuff = $('#filterAreaContentNewMessage #userStuffCheckboxList');
            if ($ddlUserStuff.find('input').length == 0) {
                bip.ajax({
                    url: 'Message/SearchIndexBindDropDowns',
                    type: 'GET',
                    success: function (data) {
                        for (var i = 0; i < data.userStuffs.length; i++) {
                            $ddlUserStuff.append($('<div class="col-md-4">' +
                                '<div class="bip-form-checkbox">' +
                                '<input type="checkbox" value="None" id="chcUserStuff' + data.userStuffs[i].ToUserStuffId + '" name="chcUserStuff' + data.userStuffs[i].ToUserStuffId + '" data-id="'+ data.userStuffs[i].ToUserStuffId +'"/>' +
                                '<label for="chcUserStuff' + data.userStuffs[i].ToUserStuffId + '" class="bip-form-checkbox-label"></label>' +
                                '<label for="chcUserStuff' + data.userStuffs[i].ToUserStuffId + '">' + data.userStuffs[i].StuffName + '</label>' +
                                '</div></div>'));
                        }
                    }
                });
            }

            var $chkDealerGroups = $('#filterAreaContentNewMessage #dealerGroupsCheckboxList');
            if ($chkDealerGroups.length > 0 && $chkDealerGroups.find('input').length == 0) {
                bip.ajax({
                    url: 'Message/SearchIndexBindDealerGroups',
                    type: 'GET',
                    success: function (data) {
                        for (var i = 0; i < data.dealerGroups.length; i++) {
                            var id = data.dealerGroups[i].Id;
                            var groupName = data.dealerGroups[i].GroupName;
                            $chkDealerGroups.append($('<div class="col-md-4">' +
                                '<div class="bip-form-checkbox">' +
                                '<input type="checkbox" value="None" id="chkDealerGroup' + id + '" name="chkDealerGroup' + id + '" data-id="'+ id +'"/>' +
                                '<label for="chkDealerGroup' + id + '" class="bip-form-checkbox-label"></label>' +
                                '<label for="chkDealerGroup' + id + '" class="label-text">' + groupName + '</label>' +
                                '</div></div>'));
                        }
                    }
                });
            }

            $("#ToIdsDivPreview").html('');
            if (mmessage.sendMessageBCCUserIds && mmessage.sendMessageUserIds) {

                if (!mmessage.IsBCC) {
                    $.each(mmessage.sendMessageUserIds, function (index, item) {
                        $('#ToIdsDivPreview').append('<span class="bip-message-to-user" data-id="' + item.id + '"><a href="#">' + item.name + ' <span class="bip-icon icon-cikis" ></span> </a><input type="hidden" name="Ids[]" value="' + item.id + '"/></span>');
                    });
                }
                else {
                    $.each(mmessage.sendMessageBCCUserIds, function (index, item) {
                        $('#ToIdsDivPreview').append('<span class="bip-message-to-user" data-id="' + item.id + '"><a href="#">' + item.name + ' <span class="bip-icon icon-cikis"></span> </a><input type="hidden" name="BCCIds[]" value="' + item.id + '"/></span>');
                    });
                }
            }
            $('#dialogNewMessage').modal("show");
        });

        $('#ToIdsFromFileDialogLink').click(function (e) {
            e.preventDefault();
            $('#dialogAddUserFromFile').modal('show');
        });

        $('#filterAreaContentNewMessage input[name="UserType"]').click(function () {
            $(this).parents('.row').toggleClass('dealer', $(this).val() == 4);
        });

        $('#containerMessages4').on('change', ':checkbox', function () {
            if (this.checked)
                mmessage.newMessage.sendMessageAddUserTo($(this).data('id'), $(this).data('name'));
            else
                mmessage.newMessage.sendMessageRemoveUserTo($(this).data('id'));
        });

        $('#ToIdsDiv,#BCCIdsDiv').on('click', function (e) {
            SetIsBCC(this);
            e.preventDefault();
            if(!mmessage.IsBCC)
                $('#ToIdsDialogLink').trigger('click');
            else
                $('#BCCIdsDialogLink').trigger('click');
        });

        $('#ToIdsDiv,#BCCIdsDiv').on('click', '.icon-cikis', function (e) {
            SetIsBCC(this);
           e.preventDefault();
            e.stopPropagation();
            mmessage.newMessage.sendMessageRemoveUserTo($(this).parents('.bip-message-to-user').data('id'));
        });
        $('#ToIdsDivPreview').on('click', '.icon-cikis', function (e) {
            e.preventDefault();
            e.stopPropagation();
                mmessage.newMessage.sendMessageRemoveUserTo($(this).parents('.bip-message-to-user').data('id'));
        });
        $('#newMessageAddAttachment').click(function(e) {
            e.preventDefault();
            var $fileInput;
            $('#attachmentsContainer').find('input[type="file"]').filter(function(i, e) {
                if ($(e).val().length == 0) {
                    $fileInput = $(e);
                    return false;
                }
            });
            if ($fileInput) {
                $fileInput.click();
            } else {
                mmessage.newMessage.attachmentIndex = mmessage.newMessage.attachmentIndex || 0;
                $('<span class="bip-message-attachment-item"><input type="file" name="Attachments[' + mmessage.newMessage.attachmentIndex + ']" /></span>').appendTo('#attachmentsContainer');
                mmessage.newMessage.attachmentIndex++;
                $('#attachmentsContainer input[type=file]:last')[0].onchange = function(e) {
                    var $this = $(this)[0];
                    if (!$this.files)
                        return;
                    if (!mmessage.common.calculateAttachmentsSize())
                        $this.value = '';
                };
                $('#attachmentsContainer input[type=file]:last')[0].click();
            }
        });

        $('#attachmentsContainer').on('click', '.bip-message-attachment-item .icon-cikis', function (e) {
            e.preventDefault();
            var attachmentId = $(this).find('input').val();
            if (mmessage.detail.detailData.detail.IsDraft) {
                if (!confirm('Silmek istediginize emin misiniz?'))
                    return;
                bip.ajax({
                    url: '/Message/DeleteDraftAttachment',
                    data: { messageId: mmessage.detail.detailData.detail.Id, attachmentId: attachmentId },
                    callback: function(data) {

                    }
                });
            }
            $(this).parents('.bip-message-attachment-item').remove();
        });

        $('#bip-messages-incoming').on('click', '.messageDraftItemTarget', function (e) {
            e.preventDefault();
            var $this = $(this).parents('li.bip-message'), id = $this.data('id');
            if (!id)
                return;
            bip.ajax({
                url: '/Message/Detail',
                data: { messageId: id, isReceivingMessage: false },
                success: function (data) {
                   
                    mmessage.detail.detailData = {
                        detail: data.detail, attachments: data.attachments, id: id, toId: 0, toUsers: data.toUsers, allMessageDetails: data.mailAllDetails
                    };
                    mmessage.newMessage.displayNewMessage(mmessage.ACTION.EditDraft);                   
                }
            });
        });
    };
    mmessage.newMessage.success = function(data) {
        bip.loading(false);
        var action = $('#formSendMessage #Action').val();
        if (data.HasError) {
            bip.errorAlert({ message: data.ResultMessages.join('\n') });
            return;
        }
        bip.infoAlert({ message: action == 'draft' ? 'Mesajiniz taslak olarak kaydedildi.' : 'Mesajiniz gönderildi.' }, function() {
            mmessage.newMessage.displayNewMessage(mmessage.ACTION.ClearNewMessage);
            mmessage.common.displayBox(action == 'draft' ? mmessage.DRAFT : mmessage.SENTBOX);
        });
    };
    mmessage.newMessage.displayNewMessage = function (action) {
        mmessage.common.displayBox(4);

        var data = mmessage.detail.detailData;
        var $form = $('#formSendMessage');
        var $subject = $form.find('input[name=Subject]');
        var $draftId = $form.find('input[name=DraftId]');

        $('#ToIdsDiv').html('');
        $('#BCCIdsDiv').html('');
        $('#ToIdsDivPreview').html('');
        $('#ToIdsDivPreview').find('span').remove();
        $('#attachmentsContainer').html('');
        mmessage.sendMessageBCCUserIds = [];
        mmessage.sendMessageUserIds = [];
        $draftId.val(0);

        if (action == mmessage.ACTION.NewMessage || action == mmessage.ACTION.ClearNewMessage) {
            $subject.val('');
            CKEDITOR.instances.Body.setData('');
            return;
        }

        if (action == mmessage.ACTION.Forward || action == mmessage.ACTION.Reply || action == mmessage.ACTION.ReplyAll) {
            CKEDITOR.instances.Body.setData('<br/><br/><hr/>' + data.detail.Body);
        }

        if (action == mmessage.ACTION.Forward) {
            $subject.val('Ilt: ' + data.detail.Subject);
            if (data.attachments) {
                $('#templateMessageNewMessageAttachment').tmpl(data).appendTo('#attachmentsContainer');
            }
        }
        if (action == mmessage.ACTION.EditDraft) {
            mmessage.sendMessageUserIds = [];
            $draftId.val(data.detail.Id);
            $subject.val(data.detail.Subject);
            CKEDITOR.instances.Body.setData(data.detail.Body);
            if (data.attachments) {
                $('#templateMessageNewMessageAttachment').tmpl(data).appendTo('#attachmentsContainer');
            }
        }
        if (action == mmessage.ACTION.Reply ) {
            $subject.val('YNT: ' + data.detail.Subject);
            mmessage.newMessage.sendMessageAddUserTo(data.detail.UserId, data.detail.Firstname + ' ' + data.detail.Lastname);
        }
        if (action == mmessage.ACTION.ReplyAll || action == mmessage.ACTION.EditDraft) {

            var currentBCC = mmessage.IsBCC;
            var toForwardList = data.allMessageDetails.ToForward;
           
            mmessage.IsBCC = false;
            if (toForwardList.length > 0) {
                for (var i = 0; i < toForwardList.length; i++) {
                    mmessage.newMessage.sendMessageAddUserTo(toForwardList[i].UserId, toForwardList[i].Firstname + ' ' + toForwardList[i].Lastname);
                }
            }
            mmessage.IsBCC = true;
            var bccForwardList = data.allMessageDetails.BccForward;           
            if (bccForwardList.length > 0) {
                for (var i = 0; i < bccForwardList.length; i++) {
                    mmessage.newMessage.sendMessageAddUserTo(bccForwardList[i].UserId, bccForwardList[i].Firstname + ' ' + bccForwardList[i].Lastname);
                }
            }
            mmessage.IsBCC = currentBCC;
        }          
    };
    mmessage.newMessage.sendMessageAddUserTo = function (id, name) {
        if (!mmessage.IsBCC) {
            var index = mmessage.sendMessageUserIds.findIndex(function (user) {
                return user.id === id;
            });
            if (index > -1) {
                return;
            };
            mmessage.sendMessageUserIds.push({ id: id, name: name });

            $('#ToIdsDiv').append('<span class="bip-message-to-user" data-id="' + id + '"><a href="#">' + name + ' <span class="bip-icon icon-cikis" data-type="CC"></span> </a><input type="hidden" name="Ids[]" value="' + id + '"/></span>');
        }
        else {
            var index = mmessage.sendMessageBCCUserIds.findIndex(function (user) {
                return user.id === id;
            });
            if (index > -1) {
                return;
            };
            mmessage.sendMessageBCCUserIds.push({ id: id, name: name });

            $('#BCCIdsDiv').append('<span class="bip-message-to-user" data-id="' + id + '"><a href="#">' + name + ' <span class="bip-icon icon-cikis" data-type="BCC"></span> </a><input type="hidden" name="BCCIds[]" value="' + id + '"/></span>');
        }
        $('#ToIdsDivPreview').append('<span class="bip-message-to-user" data-id="' + id + '"><a href="#">' + name + ' <span class="bip-icon icon-cikis"></span> </a><input type="hidden" name="Ids[]" value="' + id + '"/></span>');
    }
    mmessage.newMessage.sendMessageRemoveUserTo = function (id) {
        if (!mmessage.IsBCC) {
            var index = mmessage.sendMessageUserIds.findIndex(function (user) {
                return user.id === id;
            });
          mmessage.sendMessageUserIds.splice(index, 1);

            $('#ToIdsDiv').find('span[data-id="' + id + '"]').remove();
        }
        else {

            var index = mmessage.sendMessageBCCUserIds.findIndex(function (user) {
                return user.id === id;
            });
            mmessage.sendMessageBCCUserIds.splice(index, 1);
           $('#BCCIdsDiv').find('span[data-id="' + id + '"]').remove();
        }
        $('#ToIdsDivPreview').find('span[data-id="' + id + '"]').remove();
        $('#ToUser' + id).prop('checked', false);
    };
    mmessage.newMessage.selectAllSendMessage = function (select) {
        $('#containerMessages4').find(':checkbox').prop('checked', select).each(function () {
            $(this).trigger('change');
        });
        return false;
    };
    mmessage.detail.isFullscreen = false;
    mmessage.detail.fullscreenModal = {};
    mmessage.detail.onLoad = function () {

        $('#bip-messages-incoming').on('click', '.messageItemTarget', function (e) {
            e.preventDefault();
            var $this = $(this).parents('li.bip-message'), id = $this.data('id'), toId = $this.data('toid');
            $this.removeClass('bip-message-unread');
            $this.addClass('bip-message-read');
            mmessage.detail.display(id, toId);
        });

        $('#messageDetailDiv').on('click', '.bip-messages-sbreadcrumb a', function (e) {
            e.preventDefault();
            var $this = $(this), action = $this.data('action');
            var $parent = $this.parents('.bip-messages-single'), id = $parent.data('id'), toId = $parent.data('toid');

            if ((action == 'delete' && mmessage.index != mmessage.TRASH) ||
                action == 'forward' ||
                action == 'reply' ||
                action == 'replyAll') {
                mmessage.detail.hideFullscreen();
            }

            if (action == 'delete') {
                var messageAction;
                if (mmessage.index == mmessage.INBOX) {
                    messageAction = mmessage.ACTION.DeleteInboxItems;
                } else if (mmessage.index == mmessage.SENTBOX) {
                    messageAction = mmessage.ACTION.DeleteSentboxItems;
                } else if (mmessage.index == mmessage.TRASH) {
                    messageAction = mmessage.ACTION.DeleteTrashboxItems;
                } else {
                    return;
                }
                mmessage.common.actionMessage(messageAction, { ids: [id], toIds: [toId] });
            } else if (action == 'forward') {
                mmessage.detail.forward();
            } else if (action == 'reply') {
                mmessage.detail.reply();
            } else if (action == 'replyAll') {
                mmessage.detail.replyAll();
            } else if (action == 'print') {
                var messageTitle = $('.bip-messages-sheader .bip-msh-title').html().trim();
                var messageContent = $('.bip-messages-scontent').html();
                mmessage.detail.print(messageTitle, messageContent);
            } else if (action == 'undo') {
                mmessage.common.actionMessage(mmessage.ACTION.UndoSentboxItems, { ids: [id], toIds: [toId] });
            } else if (action == 'fullscreen') {
                mmessage.detail.showFullscreen();
            }
        });
        $('#messageDetailDiv').on('click', '#messageDetailUsers', function (e) {
            e.preventDefault();         
            var $this = $(this);
            var toUserList = mmessage.detail.detailData.allMessageDetails.OtherSeenToList;

                     $.each(toUserList, function (index, value) {
           $this.after(` ,
    <a href="#">${value.Firstname} ${value.Lastname}</a>`);
            });
            $this.remove();
            mmessage.detail.detailData.toUsers = toUserList;
           
        });
        $('#messageDetailDiv').on('click', '#BCCmessageDetailUsers', function (e) {
            e.preventDefault();
            var $this = $(this);
            var bccUserList = mmessage.detail.detailData.allMessageDetails.OtherSeenBccList;

            $.each(bccUserList, function (index, value) {
                $this.after(` ,
    <a href="#">${value.Firstname} ${value.Lastname}</a>`);
            });
            $this.remove();
            mmessage.detail.detailData.toUsers = bccUserList;
        });

    };
    mmessage.detail.display = function(id, toId) {
        if (!id || id == mmessage.currentDisplayingMessageId)
            return;
        mmessage.currentDisplayingMessageId = id;
        bip.ajax({
            url: '/Message/Detail',
            data: { messageId: id, isReceivingMessage: !!toId },
            success: function (data) {
                mmessage.detail.detailData = { detail: data.detail, attachments: data.attachments, id: id, toId: toId, allMessageDetails: data.mailAllDetails };
                               $('#messageDetailDiv').show().html('').append($('#templateMessagesDetail').tmpl(mmessage.detail.detailData));
            }
        });
    };
    mmessage.detail.forward = function() {
        mmessage.newMessage.displayNewMessage(mmessage.ACTION.Forward);
    };
    mmessage.detail.reply = function () {
        mmessage.newMessage.displayNewMessage(mmessage.ACTION.Reply);
    };
    mmessage.detail.replyAll = function () {

            mmessage.newMessage.displayNewMessage(mmessage.ACTION.ReplyAll);

    };
    mmessage.detail.print = function(title, content) {
        var printWindow = window.open('', '_blank', 'height=' + screen.height + ',width=' + screen.width);
        printWindow.moveTo(0, 0);
        printWindow.document.write('<html><head><title>' + title + '</title></head><body>' + content + '</body></html>');
        printWindow.document.close(); // necessary for IE >= 10
        printWindow.focus(); // necessary for IE >= 10
        printWindow.print();
        printWindow.close();
    };
    mmessage.detail.showFullscreen = function() {
        if (mmessage.detail.isFullscreen)
            return;
        $('#messageDetailDiv .bip-messages-sbreadcrumb a[data-action="fullscreen"]').hide();
        mmessage.detail.isFullscreen = true;
        mmessage.detail.fullscreenModal = bip.dialog({
            $element: $('#messageDetailDiv'),
            backdrop: false,
            callback: function(isShow, exitCode) {
                if (!isShow) {
                    mmessage.detail.hideFullscreen(true);
                }
            }
        });
    };
    mmessage.detail.hideFullscreen = function(isCallback) {
        if (!mmessage.detail.isFullscreen)
            return;
        $('#messageDetailDiv .bip-messages-sbreadcrumb a[data-action="fullscreen"]').show();
        mmessage.detail.isFullscreen = false;
        if (isCallback) {
            $('#messageDetailDiv').show();
        } else {
            mmessage.detail.fullscreenModal.close();
        }
    };
    $(function () {
        mmessage.common.onLoad();
        mmessage.newMessage.onLoad();
        mmessage.detail.onLoad();
    });

    function SetIsBCC(e) {
        mmessage.IsBCC = $(e).data("type") === "BCC" ? true : false;
    }
</script>
<style type="text/css">

    .messagesArea {
        display: none;
    }

    #filterAreaContentNewMessage .row div.dealer {
        display: none;
    }

    #filterAreaContentNewMessage .row div.bsh {
        display: block;
    }

    #filterAreaContentNewMessage .row.dealer div.dealer {
        display: block;
    }

    #filterAreaContentNewMessage .row.dealer div.bsh {
        display: none;
    }
    /*#ToIdsDiv span {background-color: #CCC;padding: 7px;border-radius: 7px;}
    #ToIdsDiv span a { margin-left: 5px; }*/

    #ToIdsDiv, #ToIdsDivPreview, #BCCIdsDiv {
        background-color: white;
        border: 1px solid #DEDEDE;
        padding: 5px 10px;
        min-height: 28px;
        max-height: 115px;
        overflow: auto;
    }

    .bip-message-attachment-item .icon-cikis {
        cursor: pointer;
    }
</style>
<hr class="titleHr">
<div class="row">
    <ul class="bip-mtabs-list col-md-4" style="margin-bottom:0; padding-left:0;">
        <li class="bip-tabs-tab active"><a href="/Message">Iç Mesajlar</a></li>
        @if (Model.CurrentUserData.Type == BIPv2.Data.Domain.Enums.UserType.Dealer)
        {
            <li class="bip-tabs-tab"><a href="/Message/External">Dis Mesajlar</a></li>
        }
    </ul>
</div>


<div class="row" style="border:1px solid #c3c3c4; padding-top:10px;">
    <div class="col-md-2">
        <div class="row bip-messages-sidebar">
            <div class="col-md-12">
                <div class="bip-mailingmenu-box bip-messages-t-m">
                    <a href="javascript: mmessage.newMessage.displayNewMessage(mmessage.ACTION.NewMessage);" class="bip--link"><span class="bip-icon icon-sendmessage"></span> Yeni Mesaj</a>
                </div>
                <div id="messagesMenu" class="bip-mailingmenu-box">
                    <ul class="bip-mmb-plist">
                        <li><a href="#" data-index="0" class="active"><span class="bip-icon icon-messagesreceived"></span> Gelen Kutusu</a></li>
                        <li><a href="#" data-index="1"><span class="bip-icon icon-messagessend"></span> Giden Kutusu</a></li>
                        <li><a href="#" data-index="2"><span class="bip-icon icon-drafts"></span> Taslaklar</a></li>
                        @*<li><a href="#" data-index="0"><span class="bip-icon icon-people"></span> Kiþiler</a></li>
                            <li><a href="#" data-index="0"><span class="bip-icon icon-block"></span> Spam</a></li>*@
                        <li><a href="#" data-index="3"><span class="bip-icon icon-trash"></span> Çöp</a></li>
                    </ul>
                    @*<ul class="bip-mmb-slist">
                            <li><a href="#"><span class="bip-icon icon-arrow-right"></span> Temsilci</a></li>
                            <li><a href="#"><span class="bip-icon icon-arrow-right"></span> Denetçi</a></li>
                        </ul>
                        <a href="#"><span class="bip-icon icon-arrow-right"></span> Klasörleri Yönet</a>*@
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-10">
        <div class="row bip-messages-t-m">
            <div class="col-md-12">
                <div class="messagesArea">
                    <div id="filterAreaContent0" style="display: none">
                        <div class="col-md-2">
                            <input id="FromUserName" name="FromUserName" type="text" value="" placeholder="Gönderen" style="width: 100%" />
                        </div>
                        <div class="col-md-2">
                            <input id="Subject" name="Subject" type="text" value="" placeholder="Konu" style="width: 100%" />
                        </div>
                        <div class="col-xs-2">
                            <div class="select-style">
                                <select id="Seen" name="Seen">
                                    <option value="">Okundu mu?</option>
                                    <option value="True">Okundu</option>
                                    <option value="False">Okunmadi</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-xs-3">
                            <div class="input-group">
                                <input class="form-control date-picker" id="MinCreatedDate" name="MinCreatedDate" type="text" data-date-format="DD.MM.YYYY HH:mm" value="" placeholder="Bu tarihten büyük">
                                <span class="input-group-addon">
                                    <i class="icon-calendar bigger-110"></i>
                                </span>
                            </div>
                        </div>
                        <div class="col-xs-3">
                            <div class="input-group">
                                <input class="form-control date-picker" id="MaxCreatedDate" name="MaxCreatedDate" type="text" data-date-format="DD.MM.YYYY HH:mm" value="" placeholder="Bu tarihten küçük" />
                                <span class="input-group-addon">
                                    <i class="icon-calendar bigger-110"></i>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-12 text-right">
                            <button type="submit" class="bip-button bip-button-small" value="">Ara</button>
                        </div>
                    </div>
                    <div id="indexActionsDiv" class="col-md-12 bip-messages-s-breadcrumb">
                        <div class="bip-form-checkbox">
                            <input type="checkbox" id="cInbox" name="cInbox" class="checkboxToggler" data-checkname="inbox">
                            <label for="cInbox" class="bip-form-checkbox-label"></label>
                        </div>
                        <a href="#" class="bip--link" data-action="0">Sil</a>
                        <a href="#" class="bip--link" data-action="6">Okundu Isaretle</a>
                        <a href="#" class="bip--link markUnread" data-action="7">Okunmadi Isaretle</a>
                        <a href="#" class="bip--link" onclick="$('#filterAreaContent0').toggle(); return false;">Arama</a>
                    </div>
                </div>
                <div class="messagesArea">
                    <div id="filterAreaContent1" style="display: none;">
                        <div class="col-md-12 text-right">
                            <button type="submit" class="bip-button bip-button-small" value="">Ara</button>
                        </div>
                    </div>
                    <div class="col-md-12 bip-messages-s-breadcrumb">
                        <div class="bip-form-checkbox">
                            <input type="checkbox" id="cSentbox" name="cSentbox" class="checkboxToggler" data-checkname="sentbox">
                            <label for="cSentbox" class="bip-form-checkbox-label"></label>
                        </div>
                        <a href="#" class="bip--link btnDeleteSentboxItems">Seçilenleri Sil</a>
                    </div>
                </div>
                <div class="messagesArea">
                    <div id="filterAreaContent2" style="display: none;">
                        <div class="col-md-12 text-right">
                            <button type="submit" class="bip-button bip-button-small" value="">Ara</button>
                        </div>
                    </div>
                    <div class="col-md-12 bip-messages-s-breadcrumb">
                        <div class="bip-form-checkbox">
                            <input type="checkbox" id="cDraft" name="cDraft" class="checkboxToggler" data-checkname="draft">
                            <label for="cDraft" class="bip-form-checkbox-label"></label>
                        </div>
                        <a href="#" class="bip--link btnDeleteDraftItems">Seçilenleri Sil</a>
                    </div>
                </div>
                <div class="messagesArea">
                    <div id="filterAreaContent3" style="display: none;">
                        <div class="col-md-12 text-right">
                            <button type="submit" class="bip-button bip-button-small" value="">Ara</button>
                        </div>
                    </div>
                    <div class="col-md-12 bip-messages-s-breadcrumb">
                        <div class="bip-form-checkbox">
                            <input type="checkbox" id="cTrash" name="cTrash" class="checkboxToggler" data-checkname="trash">
                            <label for="cTrash" class="bip-form-checkbox-label"></label>
                        </div>
                        <a href="#" class="bip--link btnDeleteTrashItems">Seçilenleri Tamamen Sil</a>
                        <a href="#" class="bip--link btnUndoTrashItems">Seçilenleri Geri Al</a>
                    </div>
                </div>
                <div class="messagesArea">
                    <form action="/Message/SendMessage?IFrameCallBack=mmessage.newMessage.success" target="iFrameForAjaxCall" id="formSendMessage" method="post" enctype="multipart/form-data">
                        <div id="idsInputHiddens"></div>
                        <input type="hidden" name="DraftId" value="0" />
                        <div class="row">
                            <div class="col-md-12">
                                <div class="bip-messages">
                                    <div class='bip-messages-tabs bip-mt-s'>
                                        <div class='bip-mtabs-pc'>
                                            <div id="bip-messages-sin">
                                                <div class="form-group">
                                                    <div class="row">
                                                        <div class="col-md-2">
                                                            <strong>Kime:</strong>
                                                        </div>
                                                        <div class="col-md-8">
                                                            <div id="ToIdsDiv" data-type="CC" class="block input-icon input-icon-right"></div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            @if (Model.CurrentUserData.Type == UserType.Admin || Model.CurrentUserData.Type == UserType.BSHSpecific || Model.CurrentUserData.Type == UserType.BSHGeneric)
                                                            {
                                                                <div class="row" style="margin-top: -3px;">
                                                                    <a id="ToIdsDialogLink" href="#" class="bip--link addRecipient" data-type="CC"><span class="bip-icon icon-arrow-right"></span>Kisi Ekle</a>
                                                                </div>
                                                                <div class="row">
                                                                    <a id="ToIdsFromFileDialogLink" href="#" class="bip--link addRecipient"><span class="bip-icon icon-arrow-right"></span>Dosyadan Ekle</a>
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <a id="ToIdsDialogLink" href="#" class="bip--link addRecipient" data-type="CC"><span class="bip-icon icon-arrow-right"></span>Kisi Ekle</a>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="row">
                                                        <div class="col-md-2">
                                                            <strong>BCC:</strong>
                                                        </div>
                                                        <div class="col-md-8">
                                                            <div id="BCCIdsDiv" data-type="BCC" class="block input-icon input-icon-right"></div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            @if (Model.CurrentUserData.Type == UserType.Admin || Model.CurrentUserData.Type == UserType.BSHSpecific || Model.CurrentUserData.Type == UserType.BSHGeneric)
                                                            {
                                                                <div class="row" style="margin-top: -3px;">
                                                                    <a id="BCCIdsDialogLink" href="#" class="bip--link addRecipient" data-type="BCC"><span class="bip-icon icon-arrow-right"></span>Kisi Ekle</a>
                                                                </div>
                                                                <div class="row">
                                                                    <a id="BCCIdsFromFileDialogLink" href="#" class="bip--link addRecipient"><span class="bip-icon icon-arrow-right"></span>Dosyadan Ekle</a>
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <a id="BCCIdsDialogLink" href="#" class="bip--link addRecipient" data-type="BCC"><span class="bip-icon icon-arrow-right"></span>Kisi Ekle</a>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="row">
                                                        <div class="col-md-2">
                                                            <strong>Konu: (*)</strong>
                                                        </div>
                                                        <div class="col-md-8">
                                                            <input name="Subject" class="full-width" type="text" value="" />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="row">
                                                        <div id="attachmentsContainer" class="col-md-10 col-md-offset-2">

                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="row">
                                                        <div class="col-md-10 col-md-offset-2">
                                                            <a href="#" id="newMessageAddAttachment"><strong><span class="bip-icon icon-attachment"></span> Dosya ekle</strong></a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="row">
                                                        <div class="col-md-10">
                                                            <strong>Mesaj: (*)</strong>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <textarea name="Body" id="Body" rows="10" cols="80" maxlength="4000"></textarea>
                                                </div>
                                            </div>
                                            <div id="bip-messages-sout">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <input type="hidden" name="Action" id="Action" />
                                <button type="submit" class="bip-button bip-button-large bip-button-center" value="draft">Taslak Olarak Kaydet</button>
                                <button type="submit" class="bip-button bip-button-small bip-button-center" value="send">Gönder</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div id="messageListAndDetailContainer" class="row">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-5">
                        <div class="bip-messages">
                            <div class='bip-messages-tabs'>
                                @*<div style="border-top: 1px solid #c3c3c4; height:1px; width: 323px;"></div>*@
                                <div class='bip-mtabs-pc' style="max-height: 498px; overflow-y: auto;">
                                    <ul id="bip-messages-incoming"></ul>
                                    <div id="bip-messages-outgoing">
                                        <ul></ul>
                                    </div>
                                </div>
                                @*<div style="border-top: 1px solid #c3c3c4; height:1px; width: 323px;"></div>*@
                            </div>
                            <div id="bip-messages-incoming-paging"></div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div id="messageDetailDiv" style="margin:0px -7px -1px 0px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Templates -->
<script id="templateMessages0" type="text/x-jquery-tmpl">
    {{each response.ResultValue}}
    <li data-id="${Id}" data-toid="${ToId}" class="bip-message {{if !Seen}}bip-message-unread{{/if}}">
        <div class="row">
            <div class="col-md-1 col-xs-1 bip-message-fr">
                <div class="bip-form-checkbox">
                    <input type="checkbox" value="None" id="check0_${ToId}" name="cInboxItem" data-checkname="inbox">
                    <label for="check0_${ToId}" class="bip-form-checkbox-label"></label>
                </div>
                <div>
                    <div class="bip-mail-size"><span class="bip-icon icon-read-message "></span></div>
                </div>
            </div>
            <div class="col-md-11 col-xs-11 messageItemTarget">
                <h3 class="bip-message-sender">
                    ${Firstname} ${Lastname} ${TotalSent > 1 ? '+' + (TotalSent - 1) : ''}
                </h3>
                {{if Attachments}}
                <span class="bip-icon icon-attachment"></span>
                {{/if}}
                <p class="bip-message-subject">
                    ${Subject}
                </p>
                <div class="row">
                    <div class="col-md-6">
                        <p class="bip-message-date">
                            ${moment(eval('new ' + CreatedDate.replace(/\//g,'',''))).format('DD-MM-YYYY')}
                        </p>
                    </div>
                    <div class="col-md-6 text-right">
                        @*<p class="bip-message-extra">
                                <span class="bip-icon icon-folder"></span>
                                Temsilci
                            </p>*@
                    </div>
                </div>
            </div>
        </div>
    </li>
    {{/each}}
</script>
<script id="templateMessages1" type="text/x-jquery-tmpl">
    {{each response.ResultValue}}
    <li data-id="${Id}" data-toid="${ToId}" class="bip-message {{if !Seen}}bip-message-unread{{/if}}">
        <div class="row">
            <div class="col-md-1 col-xs-1 bip-message-fr">
                <div class="bip-form-checkbox">
                    <input type="checkbox" value="None" id="check1_${Id}" name="cbDeleteSentBoxItem" data-checkname="sentbox">
                    <label for="check1_${Id}" class="bip-form-checkbox-label"></label>
                </div>
                <div>
                    <span class="bip-icon icon-read-message"></span>
                </div>
            </div>
            <div class="col-md-11 col-xs-11 messageItemTarget">
                <h3 class="bip-message-sender">
                    ${Firstname} ${Lastname} ${TotalSent > 1 ? '+' + (TotalSent - 1) : ''}
                </h3>
                {{if Attachments}}
                <span class="bip-icon icon-attachment"></span>
                {{/if}}
                <p class="bip-message-subject">
                    ${Subject}
                </p>
                <div class="row">
                    <div class="col-md-6">
                        <p class="bip-message-date">
                            ${moment(eval('new ' + CreatedDate.replace(/\//g,'',''))).format('DD-MM-YYYY')}
                        </p>
                    </div>
                    <div class="col-md-6 text-right">
                        @*<p class="bip-message-extra">
                                <span class="bip-icon icon-folder"></span>
                                Temsilci
                            </p>*@
                    </div>
                </div>
            </div>
        </div>
    </li>
    {{/each}}
</script>
<script id="templateMessages2" type="text/x-jquery-tmpl">
    {{each response.ResultValue}}
    <li data-id="${Id}" class="bip-message">
        <div class="row">
            <div class="col-md-1 bip-message-fr">
                <div class="bip-form-checkbox">
                    <input type="checkbox" value="None" id="check2_${Id}" name="cbDeleteDraftItem" data-checkname="draft">
                    <label for="check2_${Id}" class="bip-form-checkbox-label"></label>
                </div>
            </div>
            <div class="col-md-11 messageDraftItemTarget">
                <h3 class="bip-message-sender">
                    ${Firstname} ${Lastname} ${TotalSent > 1 ? '+' + (TotalSent - 1) : ''}
                </h3>
                {{if Attachments}}
                <span class="bip-icon icon-attachment"></span>
                {{/if}}
                <p class="bip-message-subject">
                    ${Subject}
                </p>
                <div class="row">
                    <div class="col-md-6">
                        <p class="bip-message-date">
                            ${moment(eval('new ' + CreatedDate.replace(/\//g,'',''))).format('DD-MM-YYYY')}
                        </p>
                    </div>
                    <div class="col-md-6 text-right">
                    </div>
                </div>
            </div>
        </div>
    </li>
    {{/each}}
</script>
<script id="templateMessages3" type="text/x-jquery-tmpl">
    {{each response.ResultValue}}
    <li data-id="${Id}" data-toid="${ToId}" class="bip-message">
        <div class="row">
            <div class="col-md-1 col-xs-1 bip-message-fr">
                <div class="bip-form-checkbox">
                    <input type="checkbox" value="None" id="check3_${Id}_${ToId}" name="cbTrashSentBoxItem" data-checkname="trash">
                    <label for="check3_${Id}_${ToId}" class="bip-form-checkbox-label"></label>
                </div>
                <div>
                    <span class="bip-icon icon-read-message"></span>
                </div>
            </div>
            <div class="col-md-11 col-xs-11 messageItemTarget">
                <h3 class="bip-message-sender">
                    ${Firstname} ${Lastname}
                </h3>
                {{if Attachments}}
                <span class="bip-icon icon-attachment"></span>
                {{/if}}
                <p class="bip-message-subject">
                    ${Subject}
                </p>
                <div class="row">
                    <div class="col-md-6">
                        <p class="bip-message-date">
                            ${moment(eval('new ' + CreatedDate.replace(/\//g,'',''))).format('DD-MM-YYYY')}
                        </p>
                    </div>
                    <div class="col-md-6 text-right">
                        @*<p class="bip-message-extra">
                                <span class="bip-icon icon-folder"></span>
                                Temsilci
                            </p>*@
                    </div>
                </div>
            </div>
        </div>
    </li>
    {{/each}}
</script>
<script id="templateMessages4" type="text/x-jquery-tmpl">
    {{each response.ResultValue}}
    <tr>
        <td>
            <div class="bip-form-checkbox">
                <input id="ToUser${Id}" name="ToUser" class="form-control" type="checkbox" value="True" data-id="${Id}" data-name="${Firstname} ${Lastname}" />
                <label for="ToUser${Id}" class="bip-form-checkbox-label"></label>
            </div>
        </td>
        <td>
            ${Firstname} ${Lastname}
        </td>
        <td>
            ${Email}
        </td>
        <td>
            ${StuffName}
        </td>
    </tr>
    {{/each}}
</script>
<script id="templateMessagesDetail" type="text/x-jquery-tmpl">
    <div class="bip-messages-single" data-id="${id}" data-toid="${toId}">
        <div class="bip-messages-stop">
            <div class="bip-messages-sbreadcrumb  bip-takeitback">
                <a href="#" class="bip-msbc-a" data-action="forward"><span class="bip-icon icon-redirect"></span>Ilet</a>
                <a href="#" class="bip-msbc-a" data-action="reply"><span class="bip-icon icon-sendmessage"></span>Yanitla</a>
                <a href="#" class="bip-msbc-a" data-action="replyAll"><span class="bip-icon icon-sendmessage"></span>Tümünü Yanitla</a>
                <a href="#" class="bip-msbc-a" data-action="delete"><span class="bip-icon icon-trash"></span>Sil</a>
                <a href="#" class="bip-msbc-a" data-action="print"><span class="bip-icon icon-printer2"></span>Yazdir</a>
                {{if mmessage.index == mmessage.SENTBOX && hasAccessUndoSentItem}}<a href="#" class="bip-msbc-a" data-action="undo"><span class="bip-icon icon-delete-email-back"></span>Geri Al / Sil</a>{{/if}}
                @*<a href="#" data-action="spam"><span class="bip-icon icon-block"></span>Spam Ýþaretle</a>*@
                <a href="#" class="bip-msbc-a" data-action="fullscreen"><span class="bip-icon icon-fulscreen"></span>Tam Ekran</a>
            </div>
            <div class="bip-messages-sheader" {{if mmessage.index == mmessage.SENTBOX && hasAccessUndoSentItem}} style="padding-left:16px;" {{/if}}>
                <h3 class="bip-msh-title">
                    ${detail.Subject}
                </h3>
                <div class="row">
                    <div class="col-md-2 col-xs-3">
                        <div class="bip-msh-label">
                            <strong>Kimden:</strong>
                        </div>
                        <div class="bip-msh-label">
                            <strong>Kime:</strong>
                        </div>
                        <div class="bip-msh-label">
                            <strong>Tarih:</strong>
                        </div>

                        {{if allMessageDetails.CanSeeBcc  && allMessageDetails.CanSeeFromRole}}
                        <div class="bip-msh-label">
                            <strong>BCC:</strong>
                        </div>
                        {{/if}}
                    </div>
                    <div class="col-md-10 col-xs-9">
                        <div class="bip-msh-label">
                            <span>${toId ? detail.Firstname + ' ' + detail.Lastname : '@Model.CurrentUserData.User.Firstname @Model.CurrentUserData.User.Lastname'}</span>
                        </div>
                        <div class="bip-msh-label" style="overflow: auto; max-height: 80px">
                            <span>
                                {{if allMessageDetails.SeenToUser}}
                                ${allMessageDetails.SeenToUser.Firstname + ' ' + allMessageDetails.SeenToUser.Lastname }
                                {{/if}}


                            </span>
                            &nbsp;
                            {{if allMessageDetails.OtherToCount>0 && allMessageDetails.CanSeeFromRole}}
                            <a href="#" id="messageDetailUsers">+ ${allMessageDetails.OtherToCount}</a>
                            {{/if}}
                        </div>
                        <div class="bip-msh-label">
                            <span>${moment(eval('new ' + detail.CreatedDate.replace(/\//g,'',''))).format('DD-MM-YYYY HH:mm')}</span>
                        </div>


                        {{if allMessageDetails.CanSeeBcc  && allMessageDetails.CanSeeFromRole && allMessageDetails.SeenBccUser}}
                        <div class="bip-msh-label">
                            <span>
                                ${allMessageDetails.SeenBccUser.Firstname + ' ' + allMessageDetails.SeenBccUser.Lastname}

                            </span>
                            {{if allMessageDetails.OtherBccCount>0 && allMessageDetails.CanSeeFromRole}}
                            <a href="#" id="BCCmessageDetailUsers">+ ${allMessageDetails.OtherBccCount} </a>
                            {{/if}}
                        </div>
                        {{/if}}
                    </div>
                </div>
                <div class="row attachmentCont">
                    {{if detail.Attachments}}
                    {{each attachments}}
                    <span class="bip-icon icon-attachment"></span><a href="/FileManagement/Download?filename=${encodeURIComponent(Name)}&file=/Upload/Message/${Path}" target="_blank">${Name} (${NUEVO.file.formatBytes(ContentLength)})</a>
                    {{/each}}
                    {{/if}}
                </div>
            </div>
        </div>
        <div class="bip-messages-scontent" style="height:320px; overflow-y:auto;">
            {{html detail.Body}}
        </div>
    </div>
</script>

<script id="templateMessagesUsers" type="text/x-jquery-tmpl">
    {{each ResultValue}}
    ,
    <a href="#">${Firstname} ${Lastname}</a>
    {{/each}}
</script>
<script id="templateMessageNewMessageAttachment" type="text/x-jquery-tmpl">
    {{each attachments}}
    <span class="bip-message-attachment-item">
        <span class="bip-icon icon-attachment">
            <a href="/FileManagement/Download?filename=${Name}&file=/Upload/Message/${Path}" target="_blank">${Name} (${NUEVO.file.formatBytes(ContentLength)})</a>
        </span> <span class="bip-icon icon-cikis">
            <input type="hidden" name="AttachmentIds[]" value="${Id}" />
        </span>
    </span>
    {{/each}}
</script>
@Html.Partial("PartialViews/Message/AddUserToReceivers")
@Html.Partial("PartialViews/Message/AddUserToReceiversFromFile")
